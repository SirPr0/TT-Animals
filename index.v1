<html>
	<title>Animals Timer</title>
	<body>
		<div id="app"></div>
		<div id="notification-container"></div>
	</body>
	<script>
		const API_URL = 'https://tycoon-njyvop.users.cfx.re/status/farming/animals.json';

		let pkey = null;
		let focused = false;
		let tabbed = false;
		let animalsData = null;
		let isRunningInGame = false;
		let notificationsEnabled = false;
		let notificationCheckInterval = null;
		let activeNotifications = new Set();

		// Load settings from localStorage
		function loadSettings() {
			const savedKey = localStorage.getItem('animalstimer_Pkey');
			if (savedKey) {
				pkey = savedKey;
			}
			
			const savedNotifications = localStorage.getItem('animalstimer_notifications');
			if (savedNotifications !== null) {
				notificationsEnabled = savedNotifications === 'true';
			} else {
				// Default to disabled as requested
				notificationsEnabled = false;
				localStorage.setItem('animalstimer_notifications', 'false');
			}
		}

		// Save player key to localStorage
		function savePlayerKey(key) {
			localStorage.setItem('animalstimer_Pkey', key);
			pkey = key;
		}

		function clearPlayerKey() {
			localStorage.removeItem('animalstimer_Pkey');
			pkey = null;
			renderKeyInputForm();
		}

		// Toggle notifications
		function toggleNotifications() {
			notificationsEnabled = !notificationsEnabled;
			localStorage.setItem('animalstimer_notifications', notificationsEnabled.toString());
			
			if (notificationsEnabled) {
				startNotificationChecker();
			} else {
				stopNotificationChecker();
			}
			
			// Re-render animals to update bell button state
			if (animalsData) {
				renderAnimals();
			}
		}

		// Start notification checker
		function startNotificationChecker() {
			stopNotificationChecker(); // Clear any existing interval
			notificationCheckInterval = setInterval(checkForNotifications, 5 * 60 * 1000); // 5 minutes
			checkForNotifications(); // Check immediately
		}

		// Stop notification checker
		function stopNotificationChecker() {
			if (notificationCheckInterval) {
				clearInterval(notificationCheckInterval);
				notificationCheckInterval = null;
			}
		}

		// Check for notifications
		function checkForNotifications() {
			if (!animalsData || !notificationsEnabled) return;
			
			const now = Math.floor(Date.now() / 1000);
			const ownedAnimals = animalsData.animals.filter((animal) => animal.isOwned);
			
			ownedAnimals.forEach((animal) => {
				if (animal.collection_time <= now) {
					const animalName = animal.int_name.replace('farm_', '').replace(/_/g, ' ');
					// Create unique ID for this animal instance
					const notificationId = `${animalName}-${animal.collection_time}`;
					showNotification(animalName, animal.total, notificationId);
				}
			});
		}

		// Show notification banner
		function showNotification(animalName, count, notificationId) {
			// Don't show duplicate notifications
			if (activeNotifications.has(notificationId)) return;
			
			activeNotifications.add(notificationId);
			
			const notificationContainer = document.getElementById('notification-container');
			const notification = document.createElement('div');
			notification.className = 'notification';
			notification.id = `notif-${notificationId}`;
			
			notification.innerHTML = `
				<div class="notification-content">
					<div class="notification-icon">ðŸ””</div>
					<div class="notification-text">
						<strong>${animalName}</strong> (${count}) is ready to collect!
					</div>
				</div>
				<button class="notification-close">Ã—</button>
			`;
			
			// Add close button event listener
			const closeBtn = notification.querySelector('.notification-close');
			closeBtn.addEventListener('click', () => {
				removeNotification(notificationId);
			});
			
			notificationContainer.appendChild(notification);
		}

		// Remove notification
		function removeNotification(notificationId) {
			const notification = document.getElementById(`notif-${notificationId}`);
			if (notification) {
				notification.remove();
			}
			activeNotifications.delete(notificationId);
		}

		function fetchAnimals() {
			if (!pkey) {
				renderKeyInputForm();
				return;
			}

			fetch(API_URL, {
				headers: {
					'X-Tycoon-Key': pkey
				}
			})
				.then((response) => {
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				})
				.then((data) => {
					if (!data || !data.animals) {
						throw new Error('Invalid data format received');
					}
					animalsData = data;
					renderAnimals();
					// Check for notifications immediately if enabled
					if (notificationsEnabled) {
						checkForNotifications();
					}
				})
				.catch((error) => {
					console.error('Error fetching animal data:', error);
					renderErrorMessage('Failed to load animal data. Please check your API key.');
				});
		}

		function renderKeyInputForm() {
			const app = document.getElementById('app');
			app.innerHTML = `
				<div class="hud-container">
					<h2 class="form-title">Enter Private API Key</h2>
					<form id="keyForm" class="key-form">
						<input type="text" id="playerKey" class="key-input" placeholder="Enter your private api key" required>
						<button type="submit" class="key-submit">Save</button>
					</form>
				</div>
			`;

			document.getElementById('keyForm').addEventListener('submit', function (e) {
				e.preventDefault();
				const keyInput = document.getElementById('playerKey').value.trim();
				if (keyInput) {
					savePlayerKey(keyInput);
					fetchAnimals();
				}
			});
		}

		function renderErrorMessage(message) {
			const app = document.getElementById('app');
			app.innerHTML = `
				<div class="hud-container">
					<div class="header-controls">
						<button id="clearKeyBtn" class="key-clear">Clear API Key</button>
					</div>
					<div class="error-message">${message}</div>
				</div>
			`;

			document.getElementById('clearKeyBtn').addEventListener('click', function () {
				clearPlayerKey();
			});
		}

		function formatTimeLeft(timestamp) {
			if (!timestamp) return 'Not available';

			const now = Math.floor(Date.now() / 1000);
			const collectionTime = timestamp;

			if (collectionTime <= now) {
				return 'Ready to collect';
			}

			const diffSec = collectionTime - now;
			const diffHrs = Math.floor(diffSec / 3600);
			const diffMins = Math.floor((diffSec % 3600) / 60);

			return `${diffHrs}h ${diffMins}m`;
		}

		function renderAnimals() {
			if (!animalsData) return;

			const app = document.getElementById('app');
			let html = '<div class="hud-container">';

			html += '<div class="header-controls">';
			html += `<button id="notificationToggle" class="notification-toggle ${notificationsEnabled ? 'active' : ''}" title="${notificationsEnabled ? 'Notifications ON' : 'Notifications OFF'}">`;
			html += notificationsEnabled ? 'ðŸ””' : 'ðŸ”•';
			html += '</button>';
			html += '<button id="clearKeyBtn" class="key-clear">Clear API Key</button>';
			html += '</div>';

			const ownedAnimals = animalsData.animals.filter((animal) => animal.isOwned);

			if (ownedAnimals.length === 0) {
				html += '<p class="no-animals">No animals owned</p>';
			} else {
				ownedAnimals.forEach((animal) => {
					const feedPercent = Math.round((animal.feed_level / animal.feed_max) * 100);
					const animalName = animal.int_name.replace('farm_', '').replace(/_/g, ' ');

					html += `
						<div class="hud-item">
							<div class="hud-name">${animalName}</div>
							<div class="hud-details">
								<span class="hud-count">${animal.total}</span>
								<div class="hud-progress">
									<div class="hud-progress-fill" style="width: ${feedPercent}%"></div>
								</div>
								<span class="hud-time">${formatTimeLeft(animal.collection_time)}</span>
							</div>
						</div>
					`;
				});
			}

			html += '</div>';
			app.innerHTML = html;

			// Add event listeners
			document.getElementById('notificationToggle').addEventListener('click', function () {
				toggleNotifications();
			});

			document.getElementById('clearKeyBtn').addEventListener('click', function () {
				clearPlayerKey();
			});
		}

		function setActive(active) {
			const app = document.getElementById('app');

			if (active) {
				app.style.display = 'block';
				fetchAnimals();
			} else {
				app.style.display = 'none';
			}
		}

		// Handle messages from parent window
		window.addEventListener('message', (event) => {
			if (event.data.fromTycoonScript === true) {
				isRunningInGame = true;
			}

			if (event.data.data == null) return;

			if (event.data.data['focused'] !== undefined) {
				focused = event.data.data['focused'];
				setActive(focused && tabbed);
			}
			if (event.data.data['tabbed'] !== undefined) {
				tabbed = event.data.data['tabbed'];
				setActive(focused && tabbed);
			}
		});

		// Handle Escape key
		window.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				window.parent.postMessage({ type: 'pin' }, '*');
			}
		});

		// Initialize on load
		window.onload = () => {
			loadSettings();
			window.parent.postMessage({ type: 'getData' }, '*');
			setActive(true);
		};
	</script>
	<style>
		body {
			font-family: 'Arial', sans-serif;
			margin: 0;
			padding: 0;
			background-color: transparent;
			color: #fff;
			overflow: hidden;
		}

		.hud-container {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			max-width: 400px;
			width: 90%;
			background-color: rgba(0, 0, 0, 0.6);
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
		}

		.header-controls {
			display: flex;
			justify-content: space-between;
			margin-bottom: 15px;
		}

		.header-controls .key-clear {
			padding: 6px 12px;
			font-size: 12px;
		}

		.notification-toggle {
			background: none;
			border: 1px solid rgba(255, 255, 255, 0.3);
			color: white;
			padding: 6px 12px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			transition: all 0.3s;
		}

		.notification-toggle.active {
			background-color: rgba(76, 175, 80, 0.3);
			border-color: #4caf50;
		}

		.notification-toggle:hover {
			background-color: rgba(255, 255, 255, 0.1);
		}

		.hud-item {
			margin-bottom: 12px;
			padding: 8px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.2);
		}

		.hud-item:last-child {
			border-bottom: none;
			margin-bottom: 0;
		}

		.hud-name {
			font-size: 18px;
			font-weight: bold;
			text-transform: capitalize;
			margin-bottom: 5px;
		}

		.hud-details {
			display: flex;
			align-items: center;
			justify-content: space-between;
			font-size: 14px;
		}

		.hud-count {
			background-color: rgba(255, 255, 255, 0.2);
			padding: 3px 8px;
			border-radius: 4px;
			flex: 0 0 auto;
			margin-right: 8px;
		}

		.hud-progress {
			height: 8px;
			background-color: rgba(255, 255, 255, 0.2);
			border-radius: 4px;
			overflow: hidden;
			flex: 1;
			margin: 0 8px;
		}

		.hud-progress-fill {
			height: 100%;
			background-color: #4caf50;
		}

		.hud-time {
			flex: 0 0 auto;
			white-space: nowrap;
			font-size: 13px;
			color: #ddd;
		}

		.no-animals {
			text-align: center;
			color: #ccc;
			padding: 5px;
			font-size: 12px;
		}

		.error {
			display: none;
		}

		.error-message {
			color: #ff6b6b;
			text-align: center;
			padding: 10px;
			font-size: 14px;
			background-color: rgba(255, 0, 0, 0.1);
			border-radius: 5px;
			margin: 10px 0;
		}

		#dummy-button {
			display: none;
		}

		.form-title {
			text-align: center;
			margin-bottom: 10px;
			font-size: 18px;
		}

		.key-form {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.key-input {
			padding: 8px;
			margin-bottom: 10px;
			width: 100%;
			border: 1px solid #ccc;
			border-radius: 4px;
			font-size: 14px;
		}

		.button-group {
			display: flex;
			gap: 8px;
			width: 100%;
		}

		.key-submit,
		.key-clear {
			padding: 8px 16px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			flex: 1;
		}

		.key-submit {
			background-color: #4caf50;
			color: #fff;
		}

		.key-submit:hover {
			background-color: #45a049;
		}

		.key-clear {
			background-color: #f44336;
			color: #fff;
		}

		.key-clear:hover {
			background-color: #d32f2f;
		}

		/* Notification styles */
		#notification-container {
			position: fixed;
			top: 20px;
			left: 20px;
			z-index: 1000;
			display: flex;
			flex-direction: column;
			gap: 10px;
			max-width: 300px;
		}

		.notification {
			background-color: rgba(0, 0, 0, 0.85);
			border-left: 4px solid #4caf50;
			border-radius: 4px;
			padding: 12px 15px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			animation: slideIn 0.3s ease-out;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
			max-width: 300px;
		}

		@keyframes slideIn {
			from {
				transform: translateX(-100%);
				opacity: 0;
			}
			to {
				transform: translateX(0);
				opacity: 1;
			}
		}

		.notification-content {
			display: flex;
			align-items: center;
			gap: 10px;
			flex: 1;
		}

		.notification-icon {
			font-size: 18px;
			flex-shrink: 0;
		}

		.notification-text {
			font-size: 14px;
			color: #fff;
			line-height: 1.3;
		}

		.notification-text strong {
			color: #4caf50;
			text-transform: capitalize;
		}

		.notification-close {
			background: none;
			border: none;
			color: rgba(255, 255, 255, 0.5);
			font-size: 20px;
			cursor: pointer;
			padding: 0;
			margin-left: 10px;
			width: 24px;
			height: 24px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 50%;
			transition: all 0.3s;
			flex-shrink: 0;
		}

		.notification-close:hover {
			color: #fff;
			background-color: rgba(255, 255, 255, 0.1);
		}
	</style>
</html>
